<!DOCTYPE html>
<html>

<head>
    <title>login</title>
    <link rel="stylesheet" type="text/css" href="./dist/asset/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="./dist/asset/css/amazeui.css">
    <script type="text/javascript" src="./dist/asset/js/jquery-3.0.0.js"></script>
    <style type="text/css">
    [class*="am-u-"] + [class*="am-u-"]:last-child {
        float: left;
    }
    
    .memberlist {
        display: inline-block;
        position: relative;
    }
    
    .text {
        width: 100%;
        height: 20rem;
    }
    </style>
</head>

<body>
    <div>
        UserName:
        <input id="username" type="text" name="username"> Password:
        <input id="password" type="password" name="password">
        <button id="login">login</button>
    </div>
    <div style="margin-top:15px;">
        <input type="button" id="connect" value="websocket connect" />
        <input type="button" id="send" value="websocket send" />
        <input type="button" id="sendprivate" name="sendprivate">
        <input type="button" id="close" value="websocket close" />
    </div>
    <div>
        <input type="text" id="input">
    </div>
    <div class="am-g">
        <div class="am-u-sm-6">
            <textarea id="content" class="text"></textarea>
        </div>
        <div class="am-u-sm-4">
            <ul class="memberlist">
            </ul>
        </div>
    </div>
    <script type="text/javascript">
    var socket;
    $("#connect").click(function(event) {
        socket = new WebSocket("ws://127.0.0.1:9095/websocket");

        socket.onopen = function() {
            alert("Socket has been opened");
        }

        socket.onmessage = function(msg) {
            var old = $("#content").val()
            if (msg.data.charAt(0) == '2') {
                var d = eval("(" + msg.data.slice(1) + ")")
                $("#content").val(old + "\r\n" + d.From + " :" + d.Content)
            } else if (msg.data.charAt(0) == '3') {
                console.log(msg.data)
                var d = eval("(" + msg.data.slice(1) + ")")
                for (var i = d.UserIds.length - 1; i >= 0; i--) {
                    $(".memberlist").append(function(n) {
                        return "<li>" + d.UserIds[i] + "</li>";
                    });
                }
            }
        }

        socket.onclose = function() {
            alert("Socket has been closed");
        }
    });

    $("#send").click(function(event) {
        var data = {
            Id: "0",
            From: window.UserId,
            GroupId: "1",
            Content: $("#input").val(),
            Type: "msg"
        }
        socket.send("2" + JSON.stringify(data));
    });

    $("#close").click(function(event) {
        socket.close();
    })
    $("#sendprivate").click(function(event) {
        var data = {
            Id: "0",
            From: window.UserId,
            To: "1467357794367000300",
            GroupId: "0",
            Content: $("#input").val(),
            Type: "msg"
        }
        socket.send("1" + JSON.stringify(data));
    })
    </script>
    <script type="text/javascript">
    $("#login").bind("click", function() {
        $.ajax({
            url: "/login",
            contentType: 'application/json; charset=UTF-8',
            dataType: 'json',
            method: 'POST',
            data: JSON.stringify({
                UserName: $("#username").val(),
                Password: $('#password').val()
            })
        }).done(function(data) {
            if (data.StatusCode == 0) {
                //window.location = "chat.html";
                alert(data.Data.User.Id);
                window.UserId = data.Data.User.Id
            }
        });
    });
    </script>
</body>

</html>
